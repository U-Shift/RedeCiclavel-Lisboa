---
title: "Rede Ciclável Liboa - Mapa animado"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Mapa animado com a evolução da rede ciclável em Lisboa desde 2001
</br>
A informação base está disponível no site de geodados da CML: 
http://geodados.cm-lisboa.pt/datasets/440b7424a6284e0b9bf11179b95bf8d1_0

## Este repositório contém duas funções:
* GIF com evolução da rede ciclável em Lisboa, desde 20201
* Mapa interactivo em html com slide para visualizar ao longo dos anos


# GIF evolução da rede
## Importação dos dados
#### Importar packages
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(mapview)
library(units)
library(cartography)
```

#### Importar shapefiles Lisboa
```{r eval=F, message=FALSE, warning=FALSE}
#Limites de Lisboa
# LisboaLimite2 = st_read("data/Lisboa_limite.gpkg")
# LisboaLimite2 = LisboaLimite2[,c(3,5)] %>% st_transform(LisboaLimite2,  crs = 4326)
# attr(LisboaLimite2, "sf_column") = "geometry"
# colnames(LisboaLimite2)[colnames(LisboaLimite2)=="geom"] <- "geometry"
# st_write(LisboaLimite2, "data/LisboaLimite.shp", append = F)
LisboaLimite = st_read("data/LisboaLimite.shp")
```

#### Importar rede ciclável
```{r}
#actualizar para 2020 a partir do server da CML
CicloviasATUAL = st_read("https://opendata.arcgis.com/datasets/440b7424a6284e0b9bf11179b95bf8d1_0.geojson") 

CicloviasVELHA = CicloviasATUAL
#st_write(CicloviasATUAL[,c(1,4,7,19)], "data/Ciclovias072020.shp", append=F) #data deste mês
```
Alterar segmentos aqui - rezar que o OJECTID não mude quando a CML altera a BD
```{r include=FALSE}
CicloviasCORRECT = CicloviasATUAL[,c(1,4,7,19)]

#Remover os que estão a mais
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 1476 |CicloviasCORRECT$OBJECTID ==  2898 |CicloviasCORRECT$OBJECTID ==  313 | CicloviasCORRECT$OBJECTID == 2094),] #av ribeira das naus
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 2124 |CicloviasCORRECT$OBJECTID ==  3322 |CicloviasCORRECT$OBJECTID ==  2499),] #campo grande em toda a extenção
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 2312 |CicloviasCORRECT$OBJECTID ==  2313),] #travessa das recolhidas
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 609),]#braço de prata foi dividido em dois
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 1544 |CicloviasCORRECT$OBJECTID ==  1545 |CicloviasCORRECT$OBJECTID ==  1546 | CicloviasCORRECT$OBJECTID == 1547 ),]  #rio zezere

# Adicionar segmentos que foram destruídos
ADICIONAR = st_read("data/Adicionar.shp")
ADICIONAR = st_transform(ADICIONAR, st_crs(CicloviasCORRECT))
ADICIONAR$OBJECTID = as.integer(as.integer(rownames(ADICIONAR))+4000)
CicloviasA = as.data.frame(CicloviasCORRECT)
ADICIONARA = as.data.frame(ADICIONAR)
CicloviasCORRECT = rbind(CicloviasA, ADICIONARA)
CicloviasCORRECT = st_sf(CicloviasCORRECT, sf_column_name="geometry", crs = 4326)
rm(ADICIONAR,ADICIONARA,CicloviasA)


#Anos
CicloviasCORRECT$ANO = as.integer(as.character(CicloviasCORRECT$ANO))
#substituir por criação de lista, e depois filtrar por %in%
ano2003 = c(1259)
ano2005 = c(2359,1395,2360)
ano2008 = c(1190,1154)
ano2009 = c(1301,1003,1153,1115,2139,1542,2622,1543,1226,934,2453,1154,1860,2641,1344,1632,2456,1890,
            1029,1230,1257,2486,2026,2458,3015,2488,1229,2326,2792,2932)
ano2010 = c(2680,2684,1037,48,43,45,39,49,54,55,56,46,51,52,53,41,40,47,652,1412,444,446,447,448,450,
            449,442,417,2747,1141)
ano2011 = c(1434,1588,2640,1590,1589,1766)
ano2012 = c(2434,2433,1029,2859,2858,2365)
ano2013 = c(656,1765,1219,1208,1218,1763,1216,1217,1452,1764)
ano2014 = c(257,2099,3024,1232,769,2361)
ano2016 = c(1040,1041,1164,1166,1196,1197,2686,2786)
ano2015 = c(922,2881,2487,2178,2179)
ano2018 = c(2631)
ano2019 = c(772,513,511,346,1137,1174,1213,1311,1403,1484,2291,2400,2544,2682,3113,510,514)

CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2003] = 2003
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2005] = 2005
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2008] = 2008
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2009] = 2009
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2010] = 2010
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2011] = 2011
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2012] = 2012
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2013] = 2013
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2014] = 2014
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2015] = 2015
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2016] = 2016
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2018] = 2018
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID %in% ano2019] = 2019

st_write(CicloviasCORRECT, "data/CicloviasCORRECT.shp", append = F)

#o 3024 deve estar mal, deve ser +4000

```
Tipologias
```{r}
CicloviasCORRECT$TIPOLOGIA = as.character(CicloviasCORRECT$TIPOLOGIA)
table(CicloviasCORRECT$TIPOLOGIA)
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Faixas Cicláveis ou Contrafluxos"] = "Ciclovia segregada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Faixa Ciclavel"] = "Ciclovia segregada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Pista Ciclável Bidirecional"] = "Ciclovia segregada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Pista Ciclavel Bidirecional"] = "Ciclovia segregada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Pistas Cicláveis Unidirecionais"] = "Ciclovia segregada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Ponte"] = "Ciclovia segregada" #tirar o ponte ciclo-pedonal
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Zona de Coexistência"] = "Nao dedicada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Zona de Coexistencia"] = "Nao dedicada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="Bus+Bici"] = "Nao dedicada"
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$TIPOLOGIA=="30+Bici"] = "Nao dedicada"

pontes = c(1030,1031,1438,1733,2097,2277,2397,2398,2429,2430,2431,2432,2433,2434,2435,2436,2461,2462,2464,2465,2466,2467,2468,2469,2487,2494,2495,2496,2497,2971)
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$OBJECTID %in% pontes] = "Ciclovia segregada"


#Casos particulares
CicloviasCORRECT$TIPOLOGIA[CicloviasCORRECT$OBJECTID==2453] = "Nao dedicada"

#Nomes
CicloviasCORRECT$DESIGNACAO[CicloviasCORRECT$DESIGNACAO=="---- Campo Grande"] = "Campo Grande"
CicloviasCORRECT$DESIGNACAO[CicloviasCORRECT$DESIGNACAO=="---- Eixo Central"] = "Alta de Lisboa"


#tirar o trilho
CicloviasCORRECT = CicloviasCORRECT[CicloviasCORRECT$TIPOLOGIA!="Trilho",]

#tirar o "Percurso Ciclo-pedonal"?
table(CicloviasCORRECT$TIPOLOGIA)

#guardar
saveRDS(CicloviasCORRECT, "CicloviasAnos/CicloviasCORRECT.Rds")

#ver num mapa
mapview(CicloviasCORRECT, zcol="TIPOLOGIA", lwd=1.5, hide=T, legend=T)

```


Alterei alguns segmentos no QGIS, principalmente anos que não estão correctos na BD oficial. 
```{r}
#renomear
Ciclovias = CicloviasCORRECT
```


##### Acertar geometria
```{r}
#recalcular geometria
Ciclovias$lenght = st_length(Ciclovias) %>% units::set_units(km)
sum(Ciclovias$lenght)
# calma, há segmentos que foram destruídos entretanto
```

### Ver num mapa
Todas as ciclovias que existem ou existiram
```{r}
#mapview::mapview(Ciclovias)
```

## Processar dados
### Reclassificar ciclovias
Em __segregadas__ (uni e bi-direccionais) e __banalizadas__ (30+bici, zona de coexistência)
```{r}
table(Ciclovias$TIPOLOGIA)
```
#### Ver num mapa
```{r}
greens = cartography::carto.pal(pal1 = "green.pal", 2)
greens = rev(greens)
greens3 = cartography::carto.pal(pal1 = "green.pal", 3)
greens3 = rev(greens3)
mapview(Ciclovias, zcol="TIPOLOGIA", color = greens3, lwd=1.5, hide=T, legend=T)
```

### Criar tabelas para cada ano
```{r}
Ciclovias$AnoT = Ciclovias$ANO

Cic <- lapply(2001:2020, function(i) {
  subset(Ciclovias, AnoT == i)
})
Ciclovias2020T=Ciclovias[-c(1:nrow(Ciclovias)),] #para ter exaxtamente os mesmos campos que o Ciclovias

for (i in 1:length(Cic)){
  Ciclovias_ano <- Ciclovias[-c(1:nrow(Ciclovias)),] #idem
  for (j in 1:i){
    Ciclovias_ano <- rbind(Ciclovias_ano, Cic[[j]])
    Ciclovias_ano$AnoT <- j+2000
  }
    Ciclovias2020T <- rbind(Ciclovias2020T, Ciclovias_ano)
}
```
Remover as ciclovias que foram destruídas
```{r}
#remover corte do campo grande: construção do estádio Alvalade em 2003/2004
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==4016 & Ciclovias2020T$AnoT>=2003),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==4015 & Ciclovias2020T$AnoT>=2003),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==4019 & Ciclovias2020T$AnoT>=2003),]
#substituiçao do bici+BUS da avenida da liberdade pelas laterais
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==4011 & Ciclovias2020T$AnoT>=2013),]
#Desaparece o encerramento da Av Ribeira das Naus ao transito
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==1476 & Ciclovias2020T$AnoT>=2014),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==2898 & Ciclovias2020T$AnoT>=2014),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==313 & Ciclovias2020T$AnoT>=2014),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==2094 & Ciclovias2020T$AnoT>=2014),]
#É reformulada a do Campo Grande e desaparece um troço
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==4012 & Ciclovias2020T$AnoT>=2017),]
#desaparece a zona coexist junto ao rio no braço de prata, e é criada uma ciclovia
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==4006 & Ciclovias2020T$AnoT>=2018),]
#é reformulada uma ciclovia na estrada da pontinha
#Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$OBJECTID==29 & Ciclovias2020T$AnoT>=2018),]
```

```{r}
cic20=Ciclovias2020T[Ciclovias2020T$AnoT==2020,]
mapview(cic20, zcol="TIPOLOGIA", color = greens, lwd=1.5, hide=T, legend=T)
```


###Adicionar contador de km
```{r}
#Adicionar campo com extensão da rede acumulada
CicloviasKM = Ciclovias2020T[,c(3,5,6)]
st_geometry(CicloviasKM) = NULL
CicloviasKMnull = data.frame(TIPOLOGIA= c("Nao dedicada", "Nao dedicada"),
                             lenght=0, AnoT = c(2001,2002),stringsAsFactors=FALSE)
CicloviasKMnull$lenght = CicloviasKMnull$lenght %>% units::set_units(km)
CicloviasKM = rbind(CicloviasKM,CicloviasKMnull)

CicloviasKM = CicloviasKM  %>% group_by(AnoT, TIPOLOGIA) %>% summarise_at(1, sum, na.rm=TRUE)

CicloviasKM$Kms <- paste(round(CicloviasKM$lenght,digits = 0),"km", sep=" ")


#saveRDS(CicloviasKM, "CicloviasAnos/CicloviasKM.Rds")
#rm(CicloviasKMnull)
```

### Juntar cada ano e nome numa só feature
Porque senão ficava muito lento
```{r}
CicloviasAnos = Ciclovias2020T %>% group_by(DESIGNACAO,TIPOLOGIA,AnoT) %>% summarise_at(1, sum, na.rm=TRUE) 
#%>% st_union(by_feature=T)

saveRDS(CicloviasAnos, "CicloviasAnos/CicloviasAnos.Rds")
#Falta deixar o ano original!!
```

## Processar as imagens para o gif

#### criar elementos vazios nos anos em que nao aconteceu nada
```{r}
# vazios <-data.frame(TIPOLOGIA = as.character(NA),
#                    lenght = 0,
#                    Ano = as.integer(c(2002,2004,2006,2007,2015)))
# vazios$AnoT <-vazios$Ano
# vazios$geom<-st_sfc(st_multilinestring())
# vazios<-st_sf(vazios, crs=4326)
# vazios$lenght = units::set_units(vazios$lenght, km)
# CicloviasGif = rbind(Ciclovias, vazios)
```

### Criar os GIF
```{r include=FALSE}
# Defenir estilo de mapa
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 18,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    #panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.major = element_line(color = "transparent"),
    strip.text = element_text(size=14,face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"))
}
```
```{r include=FALSE}
#theme para facets, com Ano mais pequeno
mapThemeFacets <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 18,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    #panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.major = element_line(color = "transparent"),
    strip.text = element_text(size=10,face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"))
}
```


```{r eval=FALSE, include=FALSE}
#imagens em facet, em tons de cinza
ggplot()+
  geom_sf(data=LisboaLimite, aes(),color = NA)+
  geom_sf(data=CicloviasAnos,aes(fill =AnoT),color="grey70",size=1,alpha=0.2,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2001),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2003),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2005),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2008),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2009),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2010),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2011),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2012),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2013),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2014),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2016),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2017),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2018),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2019),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2020),aes(),color="black",size=1.1,show.legend=F) +
  
  facet_wrap(~AnoT, nrow=2)+ geom_text(data=CicloviasKM,aes(x=-84000,y=-107000,label=Kms), inherit.aes=FALSE) + mapThemeFacets()

```




```{r}
listaAnos = seq(1:20)+2000

RedeCiclavelLxkm <- function(Year){
  ggplot()+
  geom_sf(data= LisboaLimite, aes(),color = NA) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Ciclovia segregada" & AnoT==Year),
          aes(fill =AnoT),color="grey65",size=0.9, show.legend=F) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Nao dedicada" & AnoT==Year),
          aes(fill =AnoT),color="grey80",size=1, show.legend=F) +
  geom_sf(data=subset(CicloviasGif,TIPOLOGIA=="Ciclovia segregada" & Ano==Year),aes(),
          color="#1A7832",size=1.1,show.legend=F) +
  geom_sf(data=subset(CicloviasGif,TIPOLOGIA=="Nao dedicada" & Ano==Year),aes(),
          color="#AFD4A0",size=1.1,show.legend=F) + #lty=88 ou 11
  geom_text(data=subset(CicloviasKM,AnoT==Year),
            aes(x=-84000,y=-107000,label=Kms), size=6,inherit.aes=FALSE) +
  facet_wrap(~AnoT, nrow=1)+
  mapTheme()

  ggsave(filename=paste0("gif/",Year,"km.png"),
         units="cm",width=20, height=18, dpi=400)
}

 listaAnos %>% map_df(RedeCiclavelLxkm)

```
```{r}
#passa-se aqui qualquer coisa, às vezes dá, se for acrescentanto um a um, outras vezes não.
limite = ggplot()+mapTheme()+geom_sf(LisboaLimite,mapping=aes(), color=NA)


limite + geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Ciclovia segregada"&AnoT==2020),
                 color="#1A7832",size=0.9,show.legend=F, inherit.aes=T) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Nao dedicada" & AnoT==2020),aes(),
          color="#AFD4A0",size=1,show.legend=F) +
  geom_text(data=subset(CicloviasKM,AnoT==2020),
           aes(x=-84000,y=-107000,label=Kms), size=6,inherit.aes=F) +
  facet_wrap(~AnoT, nrow=1)


  ggsave(filename=paste0("gif/",2022,"km.png"),
         units="cm",width=20, height=18, dpi=400)
```

Usar um https://gifmaker.me com 1.5 seg de intervalo, por exemplo.

# Mapa interactivo