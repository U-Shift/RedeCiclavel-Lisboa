---
title: "Rede Ciclável Liboa - Mapa animado"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Mapa animado com a evolução da rede ciclável em Lisboa desde 2001
</br>
A informação base está disponível no site de geodados da CML: 
http://geodados.cm-lisboa.pt/datasets/440b7424a6284e0b9bf11179b95bf8d1_0

## Este repositório contém duas funções:
* GIF com evolução da rede ciclável em Lisboa, desde 20201
* Mapa interactivo em html com slide para visualizar ao longo dos anos


# GIF evolução da rede
## Importação dos dados
#### Importar packages
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(mapview)
library(units)
library(cartography)
```

#### Importar shapefiles Lisboa
```{r eval=F, message=FALSE, warning=FALSE}
#Limites de Lisboa
# LisboaLimite2 = st_read("data/Lisboa_limite.gpkg")
# LisboaLimite2 = LisboaLimite2[,c(3,5)] %>% st_transform(LisboaLimite2,  crs = 4326)
# attr(LisboaLimite2, "sf_column") = "geometry"
# colnames(LisboaLimite2)[colnames(LisboaLimite2)=="geom"] <- "geometry"
# st_write(LisboaLimite2, "data/LisboaLimite.shp", append = F)
LisboaLimite = st_read("data/LisboaLimite.shp")
```

#### Importar rede ciclável
```{r}
#actualizar para 2020 a partir do server da CML
CicloviasATUAL = st_read("https://opendata.arcgis.com/datasets/440b7424a6284e0b9bf11179b95bf8d1_0.geojson") 
#st_write(CicloviasATUAL[,c(4,7,19)], "data/Ciclovias072020.shp", append=F) #data deste mês
```
Alterei alguns segmentos no QGIS, principalmente anos que não estão correctos na BD oficial. 
```{r}
#voltar a importar
Ciclovias <-st_read("data/Ciclovias2020Julho.gpkg")
```


##### Acertar geometria
```{r}
#recalcular geometria
Ciclovias$lenght = st_length(Ciclovias) %>% units::set_units(km)
sum(Ciclovias$lenght)
# calma, há segmentos que foram destruídos entretanto
```

### Ver num mapa
Todas as ciclovias que existem ou existiram
```{r}
Ciclovias = Ciclovias %>% arrange(Ano)
Ciclovias$campo = as.integer(row.names(Ciclovias))
#mapview::mapview(Ciclovias)
```

## Processar dados
### Reclassificar ciclovias
Em __segregadas__ (uni e bi-direccionais) e __banalizadas__ (30+bici, zona de coexistência)
```{r}
Ciclovias$TIPOLOGIA = as.character(Ciclovias$TIPOLOGIA)
table(Ciclovias$TIPOLOGIA)
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Faixa Ciclavel (Contraflow)"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Faixa Ciclavel"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Pista Ciclavel Bidirecional"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Pista Ciclavel Unidirecional"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Ponte"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Zona de Coexistencia"] = "Nao dedicada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Bus+Bici"] = "Nao dedicada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="30+Bici"] = "Nao dedicada"
table(Ciclovias$TIPOLOGIA)
```
#### Ver num mapa
```{r}
greens = cartography::carto.pal(pal1 = "green.pal", 2)
greens = rev(greens)
mapview(Ciclovias, zcol="TIPOLOGIA", color = greens, lwd=1.5, hide=T, legend=T)
```

### Criar tabelas para cada ano
```{r eval=FALSE, include=FALSE}
Ciclovias$Ano = as.integer(Ciclovias$Ano)
Ciclovias$AnoT = Ciclovias$Ano
Cic01 = Ciclovias %>% subset(AnoT==2001)
Cic02 = Cic01
Cic02$AnoT = 2002 #não se passou nada
Cic03 = Ciclovias %>% subset(AnoT==2003) %>% rbind(Cic02) %>% arrange(Ano)
Cic03$AnoT = 2003
Cic03 = Cic03[-c(4,5),] #remover corte do campo grande: construção do estádio Alvalade em 2003/2004
Cic04 = Cic03
Cic04$AnoT = 2004
Cic05 = Ciclovias %>% subset(AnoT==2005) %>% rbind(Cic04) %>% arrange(Ano)
Cic05$AnoT = 2005
Cic06= Cic05
Cic06$AnoT = 2006
Cic07 = Cic06
Cic07$AnoT = 2007
Cic08 = Ciclovias %>% subset(AnoT==2008) %>% rbind(Cic07) %>% arrange(Ano)
Cic08$AnoT = 2008
Cic09 = Ciclovias %>% subset(AnoT==2009) %>% rbind(Cic08) %>% arrange(Ano)
Cic09$AnoT = 2009
Cic10 = Ciclovias %>% subset(AnoT==2010) %>% rbind(Cic09) %>% arrange(Ano)
Cic10$AnoT = 2010
Cic11 = Ciclovias %>% subset(AnoT==2011) %>% rbind(Cic10) %>% arrange(Ano)
Cic11$AnoT = 2011
Cic12 = Ciclovias %>% subset(AnoT==2012) %>% rbind(Cic11) %>% arrange(Ano)
Cic12$AnoT = 2012
Cic13 = Ciclovias %>% subset(AnoT==2013) %>% rbind(Cic12) %>% arrange(Ano)
Cic13$AnoT = 2013
Cic13 = Cic13[-c(66),] #substituiçao do bici+BUS da avenida da liberdade pelas laterais
Cic14 = Ciclovias %>% subset(AnoT==2014) %>% rbind(Cic13) %>% arrange(Ano)
Cic14$AnoT = 2014
Cic15 = Cic14 #nada de novo
Cic15$AnoT = 2015
Cic16 = Ciclovias %>% subset(AnoT==2016) %>% rbind(Cic15) %>% arrange(Ano)
Cic16$AnoT = 2016
Cic17 = Ciclovias %>% subset(AnoT==2017) %>% rbind(Cic16) %>% arrange(Ano)
Cic17$AnoT = 2017
Cic18 = Ciclovias %>% subset(AnoT==2018) %>% rbind(Cic17) %>% arrange(Ano)
Cic18$AnoT = 2018
Cic18 = Cic18[-c(27,152),] #desaparece a zona coexist junto ao rio no braço de prata, e é criada uma ciclovia. é reformulada uma ciclovia na estrada da pontinha
Cic19 = Ciclovias %>% subset(AnoT==2019) %>% rbind(Cic18) %>% arrange(Ano)
Cic19$AnoT = 2019
Cic20 = Ciclovias %>% subset(AnoT==2020) %>% rbind(Cic19) %>% arrange(Ano)
Cic20$AnoT = 2020
sum(Cic20$lenght)
#melhorar isto para uma função, remover as ciclovias depois em todos os anos dali para a frente

```

```{r}
Ciclovias$AnoT = Ciclovias$Ano

Cic <- lapply(2001:2020, function(i) {
  subset(Ciclovias, AnoT == i)
})
Ciclovias2020T=Ciclovias[-c(1:nrow(Ciclovias)),] #para ter exaxtamente os mesmos campos que o Ciclovias

for (i in 1:length(Cic)){
  Ciclovias_ano <- Ciclovias[-c(1:nrow(Ciclovias)),] #idem
  for (j in 1:i){
    Ciclovias_ano <- rbind(Ciclovias_ano, Cic[[j]])
    Ciclovias_ano$AnoT <- j+2000
  }
    Ciclovias2020T <- rbind(Ciclovias2020T, Ciclovias_ano)
}
```
Remover as ciclovias que foram destruídas
```{r}
#remover corte do campo grande: construção do estádio Alvalade em 2003/2004
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==4 & Ciclovias2020T$AnoT>=2003),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==5 & Ciclovias2020T$AnoT>=2003),]
#substituiçao do bici+BUS da avenida da liberdade pelas laterais
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==68 & Ciclovias2020T$AnoT>=2013),]
#desaparece a zona coexist junto ao rio no braço de prata, e é criada uma ciclovia
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==161 & Ciclovias2020T$AnoT>=2018),]
#é reformulada uma ciclovia na estrada da pontinha
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==29 & Ciclovias2020T$AnoT>=2018),]
```


```{r eval=FALSE, include=FALSE}
#Todos em que houve alteração
Ciclovias2020<- rbind(Cic01,Cic03,Cic05,Cic08,Cic09,Cic10,Cic11,Cic12,Cic13,Cic14,Cic16,Cic17,Cic18, Cic19, Cic20)
#Adicionar anos nulos
Ciclovias2020T<- rbind(Cic01,Cic02,Cic03,Cic04,Cic05,Cic06,Cic07,Cic08,Cic09,Cic10,Cic11,Cic12,Cic13,Cic14,Cic15,Cic16,Cic17,Cic18,Cic19,Cic20) #Tabela final

#remover o que não interessa
rm(Cic01,Cic02,Cic03,Cic04,Cic05,Cic06,Cic07,Cic08,Cic09,Cic10,
   Cic11,Cic12,Cic13,Cic14,Cic15,Cic16,Cic17,Cic18,Cic19,Cic20) 
```

###Adicionar contador de km
```{r}
#Adicionar campo com extensão da rede acumulada
CicloviasKM = Ciclovias2020T[,c(2,5)]
st_geometry(CicloviasKM) = NULL
CicloviasKM = CicloviasKM  %>% group_by(AnoT) %>% summarise_at(1, sum, na.rm=TRUE)

#CicloviasKM$Km <- round(CicloviasKM$lenght,digits = 0)
#CicloviasKM$Kmkm <- "km"
CicloviasKM$Kms <- paste(round(CicloviasKM$lenght,digits = 0),"km", sep=" ")
```

### Juntar cada ano numa só feature
Porque senão ficava muito lento
```{r}
CicloviasAnos = Ciclovias2020T %>% group_by(TIPOLOGIA,AnoT) %>% summarise_at(1, sum, na.rm=TRUE) %>% st_union(by_feature=T)
```

## Processar as imagens para o gif

#### criar elementos vazios nos anos em que nao aconteceu nada
```{r}
vazios <-data.frame(TIPOLOGIA = as.character(NA),
                   lenght = 0,
                   Ano = as.integer(c(2002,2004,2006,2007,2015)))
vazios$AnoT <-vazios$Ano
vazios$geom<-st_sfc(st_multilinestring())
vazios<-st_sf(vazios, crs=4326)
vazios$lenght = units::set_units(vazios$lenght, km)
CicloviasGif = rbind(Ciclovias, vazios)
```

### Criar os GIF
```{r include=FALSE}
# Defenir estilo de mapa
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 18,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    #panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.major = element_line(color = "transparent"),
    strip.text = element_text(size=14,face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"))
}
```
```{r include=FALSE}
#theme para facets, com Ano mais pequeno
mapThemeFacets <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 18,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    #panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.major = element_line(color = "transparent"),
    strip.text = element_text(size=10,face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"))
}
```


```{r eval=FALSE, include=FALSE}
#imagens em facet, em tons de cinza
ggplot()+
  geom_sf(data=LisboaLimite, aes(),color = NA)+
  geom_sf(data=CicloviasAnos,aes(fill =AnoT),color="grey70",size=1,alpha=0.2,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2001),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2003),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2005),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2008),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2009),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2010),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2011),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2012),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2013),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2014),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2016),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2017),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2018),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2019),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2020),aes(),color="black",size=1.1,show.legend=F) +
  
  facet_wrap(~AnoT, nrow=2)+ geom_text(data=CicloviasKM,aes(x=-84000,y=-107000,label=Kms), inherit.aes=FALSE) + mapThemeFacets()

```




```{r}
listaAnos = seq(1:20)+2000

RedeCiclavelLxkm <- function(Year){
  ggplot()+
  geom_sf(data= LisboaLimite, aes(),color = NA) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Ciclovia segregada" & AnoT==Year),
          aes(fill =AnoT),color="grey65",size=0.9, show.legend=F) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Nao dedicada" & AnoT==Year),
          aes(fill =AnoT),color="grey80",size=1, show.legend=F) +
  geom_sf(data=subset(CicloviasGif,TIPOLOGIA=="Ciclovia segregada" & Ano==Year),aes(),
          color="#1A7832",size=1.1,show.legend=F) +
  geom_sf(data=subset(CicloviasGif,TIPOLOGIA=="Nao dedicada" & Ano==Year),aes(),
          color="#AFD4A0",size=1.1,show.legend=F) + #lty=88 ou 11
  geom_text(data=subset(CicloviasKM,AnoT==Year),
            aes(x=-84000,y=-107000,label=Kms), size=6,inherit.aes=FALSE) +
  facet_wrap(~AnoT, nrow=1)+
  mapTheme()

  ggsave(filename=paste0("gif/",Year,"km.png"),
         units="cm",width=20, height=18, dpi=400)
}

 listaAnos %>% map_df(RedeCiclavelLxkm)

```
```{r}
#passa-se aqui qualquer coisa, às vezes dá, se for acrescentanto um a um, outras vezes não.
limite = ggplot()+mapTheme()+geom_sf(LisboaLimite,mapping=aes(), color=NA)


limite + geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Ciclovia segregada"&AnoT==2020),
                 color="#1A7832",size=0.9,show.legend=F, inherit.aes=T) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Nao dedicada" & AnoT==2020),aes(),
          color="#AFD4A0",size=1,show.legend=F) +
  geom_text(data=subset(CicloviasKM,AnoT==2020),
           aes(x=-84000,y=-107000,label=Kms), size=6,inherit.aes=F) +
  facet_wrap(~AnoT, nrow=1)


  ggsave(filename=paste0("gif/",2022,"km.png"),
         units="cm",width=20, height=18, dpi=400)
```

Usar um https://gifmaker.me com 1.5 seg de intervalo, por exemplo.

# Mapa interactivo