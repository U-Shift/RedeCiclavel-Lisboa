---
title: "Rede Ciclável Liboa - Mapa animado"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Mapa animado com a evolução da rede ciclável em Lisboa desde 2001
</br>
A informação base está disponível no site de geodados da CML: 
http://geodados.cm-lisboa.pt/datasets/440b7424a6284e0b9bf11179b95bf8d1_0

## Este repositório contém duas funções:
* GIF com evolução da rede ciclável em Lisboa, desde 20201
* Mapa interactivo em html com slide para visualizar ao longo dos anos


# GIF evolução da rede
## Importação dos dados
#### Importar packages
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(mapview)
library(units)
library(cartography)
```

#### Importar shapefiles Lisboa
```{r eval=F, message=FALSE, warning=FALSE}
#Limites de Lisboa
# LisboaLimite2 = st_read("data/Lisboa_limite.gpkg")
# LisboaLimite2 = LisboaLimite2[,c(3,5)] %>% st_transform(LisboaLimite2,  crs = 4326)
# attr(LisboaLimite2, "sf_column") = "geometry"
# colnames(LisboaLimite2)[colnames(LisboaLimite2)=="geom"] <- "geometry"
# st_write(LisboaLimite2, "data/LisboaLimite.shp", append = F)
LisboaLimite = st_read("data/LisboaLimite.shp")
```

#### Importar rede ciclável
```{r}
#actualizar para 2020 a partir do server da CML
CicloviasATUAL = st_read("https://opendata.arcgis.com/datasets/440b7424a6284e0b9bf11179b95bf8d1_0.geojson") 
#st_write(CicloviasATUAL[,c(1,4,7,19)], "data/Ciclovias072020.shp", append=F) #data deste mês
```
Alterar segmentos aqui - rezar que o OJECTID não mude quando a CML altera a BD
```{r include=FALSE}
CicloviasCORRECT = CicloviasATUAL[,c(1,4,7,19)]

#Remover os que estão a mais
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 1476 |CicloviasCORRECT$OBJECTID ==  2898 |CicloviasCORRECT$OBJECTID ==  313 | CicloviasCORRECT$OBJECTID == 2094),] #av ribeira das naus
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 2124 |CicloviasCORRECT$OBJECTID ==  3322 |CicloviasCORRECT$OBJECTID ==  2499),] #campo grande em toda a extenção
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 2312 |CicloviasCORRECT$OBJECTID ==  2313),] #travessa das recolhidas
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 609),]#braço de prata foi dividido em dois
CicloviasCORRECT = CicloviasCORRECT[!(CicloviasCORRECT$OBJECTID == 1544 |CicloviasCORRECT$OBJECTID ==  1545 |CicloviasCORRECT$OBJECTID ==  1546 | CicloviasCORRECT$OBJECTID == 1547 |CicloviasCORRECT$OBJECTID ==  1581 | 
CicloviasCORRECT$OBJECTID == 1582 ),]  #rio zezere

# Adicionar segmentos que foram destruídos
ADICIONAR = st_read("data/Adicionar.shp")
ADICIONAR = st_transform(ADICIONAR, st_crs(CicloviasCORRECT))
ADICIONAR$OBJECTID = as.integer(as.integer(rownames(ADICIONAR))+4000)
CicloviasA = as.data.frame(CicloviasCORRECT)
ADICIONARA = as.data.frame(ADICIONAR)
CicloviasCORRECT = rbind(CicloviasA, ADICIONARA)
CicloviasCORRECT = st_sf(CicloviasCORRECT, sf_column_name="geometry", crs = 4326)
rm(ADICIONAR,ADICIONARA,CicloviasA)

#Anos
CicloviasCORRECT$ANO = as.integer(as.character(CicloviasCORRECT$ANO))
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==1259]=2003
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==2359 | CicloviasCORRECT$OBJECTID==1395| CicloviasCORRECT$OBJECTID==2360]=2005
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==1190 | CicloviasCORRECT$OBJECTID==1154]=2008
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==1301 | CicloviasCORRECT$OBJECTID==1003| CicloviasCORRECT$OBJECTID==1153 | CicloviasCORRECT$OBJECTID==1115| CicloviasCORRECT$OBJECTID==2139 | CicloviasCORRECT$OBJECTID==1542| CicloviasCORRECT$OBJECTID==2622 | CicloviasCORRECT$OBJECTID==1543| CicloviasCORRECT$OBJECTID==1226 | CicloviasCORRECT$OBJECTID==934]=2009
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==2453 | CicloviasCORRECT$OBJECTID==1154| CicloviasCORRECT$OBJECTID==1860 | CicloviasCORRECT$OBJECTID==2641| CicloviasCORRECT$OBJECTID==1344 | CicloviasCORRECT$OBJECTID==1632| CicloviasCORRECT$OBJECTID==2456 | CicloviasCORRECT$OBJECTID==1890|
CicloviasCORRECT$OBJECTID==1029 | CicloviasCORRECT$OBJECTID==1230|
CicloviasCORRECT$OBJECTID==1257 | CicloviasCORRECT$OBJECTID==2486|
CicloviasCORRECT$OBJECTID==2026 | CicloviasCORRECT$OBJECTID==2458|
CicloviasCORRECT$OBJECTID==3015 | CicloviasCORRECT$OBJECTID==2488|
CicloviasCORRECT$OBJECTID==2792 | CicloviasCORRECT$OBJECTID==2932]=2009
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==2680 | CicloviasCORRECT$OBJECTID==2684| CicloviasCORRECT$OBJECTID==1037 | CicloviasCORRECT$OBJECTID==48| CicloviasCORRECT$OBJECTID==43 | CicloviasCORRECT$OBJECTID==45| CicloviasCORRECT$OBJECTID==39 | CicloviasCORRECT$OBJECTID==49| CicloviasCORRECT$OBJECTID==54 | CicloviasCORRECT$OBJECTID==55| CicloviasCORRECT$OBJECTID==56 |CicloviasCORRECT$OBJECTID==46 | CicloviasCORRECT$OBJECTID==51| CicloviasCORRECT$OBJECTID==52 | CicloviasCORRECT$OBJECTID==53 | CicloviasCORRECT$OBJECTID==41 | CicloviasCORRECT$OBJECTID==40 | CicloviasCORRECT$OBJECTID==47 | CicloviasCORRECT$OBJECTID==652 | CicloviasCORRECT$OBJECTID==1412 |CicloviasCORRECT$OBJECTID==444| CicloviasCORRECT$OBJECTID==446|CicloviasCORRECT$OBJECTID==447| CicloviasCORRECT$OBJECTID==448|CicloviasCORRECT$OBJECTID==450| CicloviasCORRECT$OBJECTID==449| CicloviasCORRECT$OBJECTID==442| CicloviasCORRECT$OBJECTID==417|
CicloviasCORRECT$OBJECTID==2747| CicloviasCORRECT$OBJECTID==1141]=2010
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==1434 | CicloviasCORRECT$OBJECTID==1588| CicloviasCORRECT$OBJECTID==2640 | CicloviasCORRECT$OBJECTID==1590| CicloviasCORRECT$OBJECTID==1589 | CicloviasCORRECT$OBJECTID==1766]=2011
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==2434 | CicloviasCORRECT$OBJECTID==2433| CicloviasCORRECT$OBJECTID==1029 | CicloviasCORRECT$OBJECTID==2859| CicloviasCORRECT$OBJECTID==2858 |CicloviasCORRECT$OBJECTID==2365]=2012
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==656 | CicloviasCORRECT$OBJECTID==1765| CicloviasCORRECT$OBJECTID==1219 | CicloviasCORRECT$OBJECTID==1208| CicloviasCORRECT$OBJECTID==1218 |CicloviasCORRECT$OBJECTID==1763 | CicloviasCORRECT$OBJECTID==1216 | CicloviasCORRECT$OBJECTID==1217 | CicloviasCORRECT$OBJECTID==1452 | CicloviasCORRECT$OBJECTID==1764]=2013
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==257 | CicloviasCORRECT$OBJECTID==2099| CicloviasCORRECT$OBJECTID==3024 | CicloviasCORRECT$OBJECTID==1232| 
CicloviasCORRECT$OBJECTID==769 | CicloviasCORRECT$OBJECTID==2361]=2014
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==922 | CicloviasCORRECT$OBJECTID==2881| CicloviasCORRECT$OBJECTID==2487 | CicloviasCORRECT$OBJECTID==2178 | CicloviasCORRECT$OBJECTID==2179]=2015
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==2631]=2018
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==772 | CicloviasCORRECT$OBJECTID==513| CicloviasCORRECT$OBJECTID==511 | CicloviasCORRECT$OBJECTID==346| CicloviasCORRECT$OBJECTID==1137 | CicloviasCORRECT$OBJECTID==1174| CicloviasCORRECT$OBJECTID==1213 | CicloviasCORRECT$OBJECTID==1311| CicloviasCORRECT$OBJECTID==1403 | CicloviasCORRECT$OBJECTID==1484| CicloviasCORRECT$OBJECTID==2291 | CicloviasCORRECT$OBJECTID==2400| CicloviasCORRECT$OBJECTID==2544| CicloviasCORRECT$OBJECTID==2682 | CicloviasCORRECT$OBJECTID==3113| CicloviasCORRECT$OBJECTID==510 | CicloviasCORRECT$OBJECTID==514]=2019

# Passeio dos Jacarandás
CicloviasCORRECT$ANO[CicloviasCORRECT$OBJECTID==1040 | CicloviasCORRECT$OBJECTID==1041| CicloviasCORRECT$OBJECTID==1164 | CicloviasCORRECT$OBJECTID==1166|  CicloviasCORRECT$OBJECTID==1196 | CicloviasCORRECT$OBJECTID==1197| CicloviasCORRECT$OBJECTID==2686 | CicloviasCORRECT$OBJECTID==2786]=2016


st_write(CicloviasCORRECT, "data/CicloviasCORRECT.shp", append = F)

#o 3024 deve estar mal, deve ser +4000


#Tipologias
mapview(CicloviasCORRECT, zcol="TIPOLOGIA", lwd=1.5, hide=T, legend=T)





```

Alterei alguns segmentos no QGIS, principalmente anos que não estão correctos na BD oficial. 
```{r}
#voltar a importar
Ciclovias <-st_read("data/Ciclovias2020Julho.gpkg")
```


##### Acertar geometria
```{r}
#recalcular geometria
Ciclovias$lenght = st_length(Ciclovias) %>% units::set_units(km)
sum(Ciclovias$lenght)
# calma, há segmentos que foram destruídos entretanto
```

### Ver num mapa
Todas as ciclovias que existem ou existiram
```{r}
Ciclovias = Ciclovias %>% arrange(Ano)
Ciclovias$campo = as.integer(row.names(Ciclovias))
#mapview::mapview(Ciclovias)
```

## Processar dados
### Reclassificar ciclovias
Em __segregadas__ (uni e bi-direccionais) e __banalizadas__ (30+bici, zona de coexistência)
```{r}
Ciclovias$TIPOLOGIA = as.character(Ciclovias$TIPOLOGIA)
table(Ciclovias$TIPOLOGIA)
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Faixa Ciclavel (Contraflow)"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Faixa Ciclavel"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Pista Ciclavel Bidirecional"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Pista Ciclavel Unidirecional"] = "Ciclovia segregada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Ponte"] = "Ciclovia segregada" #tirar o ponte ciclo-pedonal
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Zona de Coexistencia"] = "Nao dedicada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="Bus+Bici"] = "Nao dedicada"
Ciclovias$TIPOLOGIA[Ciclovias$TIPOLOGIA=="30+Bici"] = "Nao dedicada"
#tirar o "Percurso Ciclo-pedonal"?
table(Ciclovias$TIPOLOGIA)
```
#### Ver num mapa
```{r}
greens = cartography::carto.pal(pal1 = "green.pal", 2)
greens = rev(greens)
mapview(Ciclovias, zcol="TIPOLOGIA", color = greens, lwd=1.5, hide=T, legend=T)
```

### Criar tabelas para cada ano
```{r eval=FALSE, include=FALSE}
Ciclovias$Ano = as.integer(Ciclovias$Ano)
Ciclovias$AnoT = Ciclovias$Ano
Cic01 = Ciclovias %>% subset(AnoT==2001)
Cic02 = Cic01
Cic02$AnoT = 2002 #não se passou nada
Cic03 = Ciclovias %>% subset(AnoT==2003) %>% rbind(Cic02) %>% arrange(Ano)
Cic03$AnoT = 2003
Cic03 = Cic03[-c(4,5),] #remover corte do campo grande: construção do estádio Alvalade em 2003/2004
Cic04 = Cic03
Cic04$AnoT = 2004
Cic05 = Ciclovias %>% subset(AnoT==2005) %>% rbind(Cic04) %>% arrange(Ano)
Cic05$AnoT = 2005
Cic06= Cic05
Cic06$AnoT = 2006
Cic07 = Cic06
Cic07$AnoT = 2007
Cic08 = Ciclovias %>% subset(AnoT==2008) %>% rbind(Cic07) %>% arrange(Ano)
Cic08$AnoT = 2008
Cic09 = Ciclovias %>% subset(AnoT==2009) %>% rbind(Cic08) %>% arrange(Ano)
Cic09$AnoT = 2009
Cic10 = Ciclovias %>% subset(AnoT==2010) %>% rbind(Cic09) %>% arrange(Ano)
Cic10$AnoT = 2010
Cic11 = Ciclovias %>% subset(AnoT==2011) %>% rbind(Cic10) %>% arrange(Ano)
Cic11$AnoT = 2011
Cic12 = Ciclovias %>% subset(AnoT==2012) %>% rbind(Cic11) %>% arrange(Ano)
Cic12$AnoT = 2012
Cic13 = Ciclovias %>% subset(AnoT==2013) %>% rbind(Cic12) %>% arrange(Ano)
Cic13$AnoT = 2013
Cic13 = Cic13[-c(66),] #substituiçao do bici+BUS da avenida da liberdade pelas laterais
Cic14 = Ciclovias %>% subset(AnoT==2014) %>% rbind(Cic13) %>% arrange(Ano)
Cic14$AnoT = 2014
Cic15 = Cic14 #nada de novo
Cic15$AnoT = 2015
Cic16 = Ciclovias %>% subset(AnoT==2016) %>% rbind(Cic15) %>% arrange(Ano)
Cic16$AnoT = 2016
Cic17 = Ciclovias %>% subset(AnoT==2017) %>% rbind(Cic16) %>% arrange(Ano)
Cic17$AnoT = 2017
Cic18 = Ciclovias %>% subset(AnoT==2018) %>% rbind(Cic17) %>% arrange(Ano)
Cic18$AnoT = 2018
Cic18 = Cic18[-c(27,152),] #desaparece a zona coexist junto ao rio no braço de prata, e é criada uma ciclovia. é reformulada uma ciclovia na estrada da pontinha
Cic19 = Ciclovias %>% subset(AnoT==2019) %>% rbind(Cic18) %>% arrange(Ano)
Cic19$AnoT = 2019
Cic20 = Ciclovias %>% subset(AnoT==2020) %>% rbind(Cic19) %>% arrange(Ano)
Cic20$AnoT = 2020
sum(Cic20$lenght)
#melhorar isto para uma função, remover as ciclovias depois em todos os anos dali para a frente

```

```{r}
Ciclovias$AnoT = Ciclovias$Ano

Cic <- lapply(2001:2020, function(i) {
  subset(Ciclovias, AnoT == i)
})
Ciclovias2020T=Ciclovias[-c(1:nrow(Ciclovias)),] #para ter exaxtamente os mesmos campos que o Ciclovias

for (i in 1:length(Cic)){
  Ciclovias_ano <- Ciclovias[-c(1:nrow(Ciclovias)),] #idem
  for (j in 1:i){
    Ciclovias_ano <- rbind(Ciclovias_ano, Cic[[j]])
    Ciclovias_ano$AnoT <- j+2000
  }
    Ciclovias2020T <- rbind(Ciclovias2020T, Ciclovias_ano)
}
```
Remover as ciclovias que foram destruídas
```{r}
##aqui somar 4000 ou ver qual o número que tinham... na shape Actualizar
#remover corte do campo grande: construção do estádio Alvalade em 2003/2004 - 3317,3318, 3321
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==4 & Ciclovias2020T$AnoT>=2003),]
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==5 & Ciclovias2020T$AnoT>=2003),]
#substituiçao do bici+BUS da avenida da liberdade pelas laterais - 4011
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==68 & Ciclovias2020T$AnoT>=2013),]
#desaparece a zona coexist junto ao rio no braço de prata, e é criada uma ciclovia - 4006
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==161 & Ciclovias2020T$AnoT>=2018),]
#é reformulada uma ciclovia na estrada da pontinha
Ciclovias2020T =Ciclovias2020T[!(Ciclovias2020T$campo==29 & Ciclovias2020T$AnoT>=2018),]
#É reformulada a do Campo Grande e desaparece um troço - 3314
#Desaparece o encerramento da Av Ribeira das Naus ao transito - 1476, 2898, 313, 2094
```
```{r}
cic20=Ciclovias2020T[Ciclovias2020T$AnoT==2020,]
mapview(Cic20, zcol="TIPOLOGIA", color = greens, lwd=1.5, hide=T, legend=T)
```


```{r eval=FALSE, include=FALSE}
#Todos em que houve alteração
Ciclovias2020<- rbind(Cic01,Cic03,Cic05,Cic08,Cic09,Cic10,Cic11,Cic12,Cic13,Cic14,Cic16,Cic17,Cic18, Cic19, Cic20)
#Adicionar anos nulos
Ciclovias2020T<- rbind(Cic01,Cic02,Cic03,Cic04,Cic05,Cic06,Cic07,Cic08,Cic09,Cic10,Cic11,Cic12,Cic13,Cic14,Cic15,Cic16,Cic17,Cic18,Cic19,Cic20) #Tabela final

#remover o que não interessa
rm(Cic01,Cic02,Cic03,Cic04,Cic05,Cic06,Cic07,Cic08,Cic09,Cic10,
   Cic11,Cic12,Cic13,Cic14,Cic15,Cic16,Cic17,Cic18,Cic19,Cic20) 
```

###Adicionar contador de km
```{r}
#Adicionar campo com extensão da rede acumulada
CicloviasKM = Ciclovias2020T[,c(2,5)]
st_geometry(CicloviasKM) = NULL
CicloviasKM = CicloviasKM  %>% group_by(AnoT) %>% summarise_at(1, sum, na.rm=TRUE)

#CicloviasKM$Km <- round(CicloviasKM$lenght,digits = 0)
#CicloviasKM$Kmkm <- "km"
CicloviasKM$Kms <- paste(round(CicloviasKM$lenght,digits = 0),"km", sep=" ")
```

### Juntar cada ano numa só feature
Porque senão ficava muito lento
```{r}
CicloviasAnos = Ciclovias2020T %>% group_by(TIPOLOGIA,AnoT) %>% summarise_at(1, sum, na.rm=TRUE) %>% st_union(by_feature=T)
```

## Processar as imagens para o gif

#### criar elementos vazios nos anos em que nao aconteceu nada
```{r}
vazios <-data.frame(TIPOLOGIA = as.character(NA),
                   lenght = 0,
                   Ano = as.integer(c(2002,2004,2006,2007,2015)))
vazios$AnoT <-vazios$Ano
vazios$geom<-st_sfc(st_multilinestring())
vazios<-st_sf(vazios, crs=4326)
vazios$lenght = units::set_units(vazios$lenght, km)
CicloviasGif = rbind(Ciclovias, vazios)
```

### Criar os GIF
```{r include=FALSE}
# Defenir estilo de mapa
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 18,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    #panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.major = element_line(color = "transparent"),
    strip.text = element_text(size=14,face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"))
}
```
```{r include=FALSE}
#theme para facets, com Ano mais pequeno
mapThemeFacets <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 18,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    #panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.major = element_line(color = "transparent"),
    strip.text = element_text(size=10,face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"))
}
```


```{r eval=FALSE, include=FALSE}
#imagens em facet, em tons de cinza
ggplot()+
  geom_sf(data=LisboaLimite, aes(),color = NA)+
  geom_sf(data=CicloviasAnos,aes(fill =AnoT),color="grey70",size=1,alpha=0.2,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2001),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2003),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2005),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2008),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2009),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2010),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2011),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2012),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2013),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2014),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2016),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2017),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2018),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2019),aes(),color="black",size=1.1,show.legend=F) +
  geom_sf(data=filter(Ciclovias,Ano==2020),aes(),color="black",size=1.1,show.legend=F) +
  
  facet_wrap(~AnoT, nrow=2)+ geom_text(data=CicloviasKM,aes(x=-84000,y=-107000,label=Kms), inherit.aes=FALSE) + mapThemeFacets()

```




```{r}
listaAnos = seq(1:20)+2000

RedeCiclavelLxkm <- function(Year){
  ggplot()+
  geom_sf(data= LisboaLimite, aes(),color = NA) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Ciclovia segregada" & AnoT==Year),
          aes(fill =AnoT),color="grey65",size=0.9, show.legend=F) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Nao dedicada" & AnoT==Year),
          aes(fill =AnoT),color="grey80",size=1, show.legend=F) +
  geom_sf(data=subset(CicloviasGif,TIPOLOGIA=="Ciclovia segregada" & Ano==Year),aes(),
          color="#1A7832",size=1.1,show.legend=F) +
  geom_sf(data=subset(CicloviasGif,TIPOLOGIA=="Nao dedicada" & Ano==Year),aes(),
          color="#AFD4A0",size=1.1,show.legend=F) + #lty=88 ou 11
  geom_text(data=subset(CicloviasKM,AnoT==Year),
            aes(x=-84000,y=-107000,label=Kms), size=6,inherit.aes=FALSE) +
  facet_wrap(~AnoT, nrow=1)+
  mapTheme()

  ggsave(filename=paste0("gif/",Year,"km.png"),
         units="cm",width=20, height=18, dpi=400)
}

 listaAnos %>% map_df(RedeCiclavelLxkm)

```
```{r}
#passa-se aqui qualquer coisa, às vezes dá, se for acrescentanto um a um, outras vezes não.
limite = ggplot()+mapTheme()+geom_sf(LisboaLimite,mapping=aes(), color=NA)


limite + geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Ciclovia segregada"&AnoT==2020),
                 color="#1A7832",size=0.9,show.legend=F, inherit.aes=T) +
  geom_sf(data=subset(CicloviasAnos,TIPOLOGIA=="Nao dedicada" & AnoT==2020),aes(),
          color="#AFD4A0",size=1,show.legend=F) +
  geom_text(data=subset(CicloviasKM,AnoT==2020),
           aes(x=-84000,y=-107000,label=Kms), size=6,inherit.aes=F) +
  facet_wrap(~AnoT, nrow=1)


  ggsave(filename=paste0("gif/",2022,"km.png"),
         units="cm",width=20, height=18, dpi=400)
```

Usar um https://gifmaker.me com 1.5 seg de intervalo, por exemplo.

# Mapa interactivo